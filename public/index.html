<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Silent Coach</title>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      color: #e5e7eb;
      background: radial-gradient(circle at top left, #1e3a8a 0, #0b1224 55%, #030712 100%);
      min-height: 100vh;
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 28px 16px 60px; }
    h1 { text-align: center; margin: 16px 0 18px; letter-spacing: .5px; }

    .row { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; align-items: center; }
    .btn {
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: #e5e7eb;
      padding: 12px 18px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 700;
      min-width: 120px;
    }
    .btn.primary { background: rgba(59,130,246,.65); }
    .btn.danger { background: rgba(220,38,38,.60); }
    .btn.gray { background: rgba(148,163,184,.18); }
    .btn:disabled { opacity: .55; cursor: not-allowed; }

    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 10px 14px;
      border-radius: 999px;
      user-select: none;
      font-weight: 700;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #22c55e; display: inline-block; }
    .dot.off { background: #64748b; }

    select {
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: #e5e7eb;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 700;
      outline: none;
      min-width: 180px;
    }

    .panel {
      margin-top: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(2,6,23,.45);
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,.28);
    }
    .panel h2 {
      margin: 0 0 10px;
      font-size: 15px;
      display: flex; align-items: center; gap: 10px;
      color: #c7d2fe;
    }
    .emoji { font-size: 18px; }
    textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(15,23,42,.45);
      color: #e5e7eb;
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      line-height: 1.45;
      font-size: 14px;
    }
    .status {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: rgba(229,231,235,.75);
    }
    .hint {
      margin-top: 10px;
      font-size: 12px;
      color: rgba(229,231,235,.72);
      text-align: center;
    }
    .msg {
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Silent Coach</h1>

    <div class="row" style="margin-bottom: 10px;">
      <button class="btn primary" id="startBtn">ğŸ”Š Start</button>
      <button class="btn danger" id="stopBtn" disabled>â›” Stop</button>
      <button class="btn gray" id="clearBtn">Clear</button>

      <span class="pill" id="micPill">
        <span class="dot off" id="micDot"></span>
        <span id="micState">ëŒ€ê¸°</span>
      </span>

      <label class="pill" style="cursor:pointer;">
        <input type="checkbox" id="coachOn" checked />
        <span>AI ì½”ì¹˜ ON</span>
      </label>
    </div>

    <div class="row" style="margin-bottom: 14px;">
      <select id="tone">
        <option value="calm" selected>tone: calm</option>
        <option value="direct">tone: direct</option>
        <option value="warm">tone: warm</option>
      </select>

      <select id="length">
        <option value="short">length: short</option>
        <option value="medium" selected>length: medium</option>
        <option value="long">length: long</option>
      </select>

      <button class="btn" id="pingBtn">ğŸ” Ping í…ŒìŠ¤íŠ¸</button>
    </div>

    <div class="panel">
      <h2><span class="emoji">ğŸ§</span> ì‹¤ì‹œê°„ ì „ì‚¬ (interim)</h2>
      <textarea id="interimText" placeholder="ì—¬ê¸°ì— ë§í•œ ë‚´ìš©ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
      <div class="status">
        <div id="micStatus">mic: ì¤€ë¹„</div>
        <div id="sttStatus"></div>
      </div>
    </div>

    <div class="panel">
      <h2><span class="emoji">ğŸ§ </span> ì½”ì¹˜ ë‹µë³€ (í…ìŠ¤íŠ¸)</h2>
      <textarea id="coachAnswer" class="msg" placeholder="AI ì½”ì¹˜ê°€ ì¼œì ¸ ìˆìœ¼ë©´ ì—¬ê¸°ì— ë‹µë³€ì´ í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
      <div class="status">
        <div id="aiStatus">ai: ì¤€ë¹„</div>
        <div id="netStatus"></div>
      </div>
    </div>

    <div class="hint">
      í…ŒìŠ¤íŠ¸: Ping â†’ Start â†’ â€œì˜¤ëŠ˜ ì§‘ì¤‘ì´ ì˜ ì•ˆ ë¼â€ ë§í•˜ê¸° â†’ Stop â†’ ì½”ì¹˜ ë‹µë³€ í™•ì¸
    </div>
  </div>

  <script>
    // ---------- DOM ----------
    const startBtn = document.getElementById("startBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const clearBtn = document.getElementById("clearBtn");
    const pingBtn  = document.getElementById("pingBtn");

    const interimText = document.getElementById("interimText");
    const coachAnswer = document.getElementById("coachAnswer");

    const toneSel = document.getElementById("tone");
    const lengthSel = document.getElementById("length");
    const coachOn = document.getElementById("coachOn");

    const micDot = document.getElementById("micDot");
    const micState = document.getElementById("micState");
    const micStatus = document.getElementById("micStatus");
    const aiStatus = document.getElementById("aiStatus");
    const netStatus = document.getElementById("netStatus");

    // ---------- Helpers ----------
    function setMic(on, label) {
      micDot.classList.toggle("off", !on);
      micState.textContent = label;
      micStatus.textContent = "mic: " + label;
    }

    function setAI(label) {
      aiStatus.textContent = "ai: " + label;
    }

    function setNet(label) {
      netStatus.textContent = label ? ("net: " + label) : "";
    }

    function appendLineToCoach(line) {
      const cur = coachAnswer.value || "";
      coachAnswer.value = (cur ? cur + "\n" : "") + line;
    }

    // ---------- Ping ----------
    pingBtn.addEventListener("click", async () => {
      setNet("ping...");
      try {
        const res = await fetch("/api/ping", { cache: "no-store" });
        const data = await res.json();
        if (data?.ok) {
          coachAnswer.value = "âœ… ping ok:\n" + JSON.stringify(data);
          setAI("ping ok");
          setNet("ok");
        } else {
          coachAnswer.value = "âŒ ping fail:\n" + JSON.stringify(data);
          setAI("ping fail");
          setNet("fail");
        }
      } catch (e) {
        coachAnswer.value = "âŒ ping ì‹¤íŒ¨: " + (e?.message || e);
        setAI("ping fail");
        setNet("error");
      }
    });

    // ---------- SpeechRecognition ----------
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let running = false;
    let finalText = "";

    function initSTT() {
      if (!SpeechRecognition) {
        setMic(false, "ë¯¸ì§€ì›");
        appendLineToCoach("âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” Web Speech API(STT)ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return false;
      }

      recognition = new SpeechRecognition();
      recognition.lang = "ko-KR";
      recognition.interimResults = true;
      recognition.continuous = true;

      recognition.onstart = () => {
        running = true;
        setMic(true, "ë“£ëŠ”ì¤‘...");
        stopBtn.disabled = false;
        startBtn.disabled = true;
      };

      recognition.onerror = (event) => {
        appendLineToCoach("âŒ STT ì˜¤ë¥˜: " + (event?.error || "unknown"));
        setMic(false, "ì˜¤ë¥˜");
        running = false;
        stopBtn.disabled = true;
        startBtn.disabled = false;
      };

      recognition.onend = () => {
        running = false;
        setMic(false, "ì¤‘ì§€");
        stopBtn.disabled = true;
        startBtn.disabled = false;
      };

      recognition.onresult = (event) => {
        let interim = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const txt = event.results[i][0].transcript;
          if (event.results[i].isFinal) finalText += txt + " ";
          else interim += txt;
        }
        // í™”ë©´ í‘œì‹œ (final + interim)
        interimText.value = (finalText + interim).trim();
      };

      return true;
    }

    // ---------- Coach Call ----------
    async function callCoach() {
      const text = (interimText.value || "").trim();
      if (!text) {
        coachAnswer.value = "(ì‘ë‹µ ì—†ìŒ) - ë³´ë‚¼ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.";
        setAI("ì™„ë£Œ");
        return;
      }

      if (!coachOn.checked) {
        coachAnswer.value = "(AI ì½”ì¹˜ OFF) - í…ìŠ¤íŠ¸ë§Œ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.";
        setAI("ì™„ë£Œ");
        return;
      }

      setAI("ìš”ì²­ì¤‘...");
      coachAnswer.value = "â³ ì½”ì¹˜ ìƒê° ì¤‘...\n\n(ìš”ì²­ í…ìŠ¤íŠ¸)\n" + text;

      try {
        const res = await fetch("/api/coach", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            text,
            tone: toneSel.value,
            length: lengthSel.value
          })
        });

        const data = await res.json();

        if (data?.ok) {
          coachAnswer.value = data.coach || "(ë¹ˆ ì‘ë‹µ)";
          setAI("ì™„ë£Œ");
        } else {
          coachAnswer.value = "âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:\n" + (data?.error || JSON.stringify(data));
          setAI("ì‹¤íŒ¨");
        }
      } catch (e) {
        coachAnswer.value = "âŒ ë„¤íŠ¸ì›Œí¬/íŒŒì‹± ì˜¤ë¥˜:\n" + (e?.message || e);
        setAI("ì‹¤íŒ¨");
      }
    }

    // ---------- Buttons ----------
    startBtn.addEventListener("click", () => {
      if (!recognition) {
        const ok = initSTT();
        if (!ok) return;
      }
      finalText = "";
      interimText.value = "";
      setAI("ì¤€ë¹„");
      try {
        recognition.start();
      } catch (e) {
        // start ì—°ì† í˜¸ì¶œ ë°©ì§€
      }
    });

    stopBtn.addEventListener("click", async () => {
      if (recognition && running) {
        try { recognition.stop(); } catch (e) {}
      } else {
        setMic(false, "ì¤‘ì§€");
      }
      // âœ… í•µì‹¬: Stop ëˆ„ë¥´ë©´ ì½”ì¹˜ í˜¸ì¶œ
      await callCoach();
    });

    clearBtn.addEventListener("click", () => {
      finalText = "";
      interimText.value = "";
      coachAnswer.value = "";
      setAI("ì¤€ë¹„");
      setNet("");
      setMic(false, "ëŒ€ê¸°");
    });

    // ì´ˆê¸° ìƒíƒœ
    setMic(false, "ëŒ€ê¸°");
    setAI("ì¤€ë¹„");
  </script>
</body>
</html>
