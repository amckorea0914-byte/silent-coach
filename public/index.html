<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Silent Coach</title>

  <!-- âœ… PWA -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0b1020" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#020617;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --blue: rgba(59,130,246,.35);
      --red: rgba(239,68,68,.35);
      --pill: rgba(255,255,255,.08);
      --shadow: 0 12px 35px rgba(0,0,0,.35);
      --radius: 22px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(59,130,246,.20), transparent 55%),
        radial-gradient(900px 520px at 80% 15%, rgba(239,68,68,.16), transparent 55%),
        radial-gradient(1200px 700px at 50% 0%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding: 26px 16px 40px;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
    }
    .title{
      text-align:center;
      font-size: 42px;
      letter-spacing:.4px;
      margin: 10px 0 18px;
      font-weight: 800;
      text-shadow: 0 10px 35px rgba(0,0,0,.35);
    }
    .topRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      margin-bottom: 12px;
    }
    .pill{
      padding: 10px 16px;
      border: 1px solid var(--border);
      background: var(--pill);
      border-radius: 999px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .dot{
      width:10px; height:10px;
      border-radius: 999px;
      background: rgba(255,255,255,.45);
      box-shadow: 0 0 0 6px rgba(255,255,255,.06);
    }
    .listening .dot{
      background: rgba(34,197,94,.95);
      box-shadow: 0 0 0 8px rgba(34,197,94,.18);
    }

    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 16px;
      padding: 12px 18px;
      font-weight:700;
      cursor:pointer;
      box-shadow: var(--shadow);
      min-width: 92px;
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .btnBlue{ background: var(--blue); }
    .btnRed{ background: var(--red); }
    .checkWrap{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      box-shadow: var(--shadow);
      font-weight:700;
    }
    .checkWrap input{ width:18px; height:18px; }

    .desc{
      max-width: 860px;
      margin: 10px auto 18px;
      color: var(--muted);
      line-height: 1.55;
      font-size: 14px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 10px;
    }
    @media (max-width: 860px){
      .title{ font-size: 34px; }
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .cardHeader{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 800;
      margin-bottom: 10px;
    }
    .emoji{
      width: 28px;
      height: 28px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
    }
    textarea{
      width:100%;
      min-height: 160px;
      resize: vertical;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 14px;
      outline:none;
      font-size: 15px;
      line-height: 1.55;
    }
    textarea::placeholder{ color: rgba(255,255,255,.35); }

    .badges{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .badge{
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.75);
      font-size: 13px;
      font-weight:700;
    }

    .wide{
      margin-top: 14px;
    }
    .footerHint{
      text-align:center;
      color: rgba(255,255,255,.45);
      font-size: 12.5px;
      margin-top: 14px;
    }
  </style>
</head>

<body>
  <div class="wrap" id="appRoot">
    <div class="title">Silent Coach</div>

    <div class="topRow">
      <div class="pill" id="listenPill">
        <div class="dot"></div>
        <div id="listenText">ëŒ€ê¸° ì¤‘â€¦</div>
      </div>

      <button class="btnBlue" id="btnStart">Start</button>
      <button class="btnRed"  id="btnStop" disabled>Stop</button>
      <button id="btnClear">Clear</button>

      <label class="checkWrap">
        <input type="checkbox" id="toggleAI" checked />
        AI ì½”ì¹˜ ON
      </label>
    </div>

    <div class="desc">
      â€¢ ë§í•˜ëŠ” ë™ì•ˆ ì¦‰ì‹œ ìë§‰(interim) í‘œì‹œ<br/>
      â€¢ ë§ì´ ëë‚˜ë©´ ìµœì¢… ì „ì‚¬(final) ëˆ„ì <br/>
      â€¢ ìµœì¢… ì „ì‚¬ê°€ ì—°ì†ìœ¼ë¡œ ë“¤ì–´ì™€ë„ AIëŠ” ë””ë°”ìš´ìŠ¤ë¡œ 1íšŒë§Œ í˜¸ì¶œ
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div class="emoji">ğŸ™ï¸</div>
          <div>ì‹¤ì‹œê°„ ì „ì‚¬ (interim)</div>
        </div>
        <textarea id="interimBox" placeholder="ì—¬ê¸°ì— ë§í•œ ë‚´ìš©ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤..."></textarea>

        <div class="badges">
          <div class="badge" id="micBadge">ë§ˆì´í¬: ì¤€ë¹„</div>
          <div class="badge" id="srBadge">ì¸ì‹: ì¤€ë¹„</div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="emoji">ğŸ§ </div>
          <div>ì½”ì¹˜ ë‹µë³€ (í…ìŠ¤íŠ¸)</div>
        </div>
        <textarea id="coachBox" placeholder="AI ì½”ì¹˜ê°€ ì¼œì ¸ ìˆìœ¼ë©´ ì—¬ê¸°ì— ë‹µë³€ì´ í‘œì‹œë©ë‹ˆë‹¤..."></textarea>

        <div class="badges">
          <div class="badge" id="toneBadge">tone: calm</div>
          <div class="badge" id="lenBadge">length: medium</div>
        </div>
      </div>
    </div>

    <div class="card wide">
      <div class="cardHeader">
        <div class="emoji">âœ…</div>
        <div>ìµœì¢… ì „ì‚¬ (ìµœê·¼ Nì¤„)</div>
      </div>
      <textarea id="finalBox" placeholder="ìµœì¢… í™•ì •ëœ ë¬¸ì¥ì´ ì—¬ê¸°ì— ìŒ“ì…ë‹ˆë‹¤..."></textarea>
    </div>

    <div class="footerHint">
      í™ˆí™”ë©´ì— ì¶”ê°€ê°€ ì•ˆ ë³´ì´ë©´: ëª¨ë°”ì¼ Chrome ë©”ë‰´(â‹®) â†’ â€œí™ˆ í™”ë©´ì— ì¶”ê°€â€
    </div>
  </div>

<script>
/* ---------------------------
  PWA: ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡
---------------------------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js").catch(()=>{});
}

/* ---------------------------
  DOM
---------------------------- */
const root = document.getElementById("appRoot");
const listenText = document.getElementById("listenText");

const btnStart = document.getElementById("btnStart");
const btnStop  = document.getElementById("btnStop");
const btnClear = document.getElementById("btnClear");

const toggleAI = document.getElementById("toggleAI");

const interimBox = document.getElementById("interimBox");
const finalBox   = document.getElementById("finalBox");
const coachBox   = document.getElementById("coachBox");

const micBadge = document.getElementById("micBadge");
const srBadge  = document.getElementById("srBadge");
const toneBadge = document.getElementById("toneBadge");
const lenBadge  = document.getElementById("lenBadge");

/* ---------------------------
  ì˜µì…˜
---------------------------- */
let tone = localStorage.getItem("sc_tone") || "calm";
let length = localStorage.getItem("sc_length") || "medium";
toneBadge.textContent = "tone: " + tone;
lenBadge.textContent = "length: " + length;

/* ---------------------------
  ìƒíƒœ
---------------------------- */
let running = false;
let finalLines = [];
const MAX_LINES = 12;

// AI í˜¸ì¶œ ë””ë°”ìš´ìŠ¤
let aiTimer = null;
const AI_DEBOUNCE_MS = 700;

/* ---------------------------
  UI helpers
---------------------------- */
function setListening(on){
  if(on){
    root.classList.add("listening");
    listenText.textContent = "ë“£ëŠ” ì¤‘â€¦";
    micBadge.textContent = "ë§ˆì´í¬: ì‚¬ìš©ì¤‘";
    srBadge.textContent  = "ì¸ì‹: ì§„í–‰ì¤‘";
  }else{
    root.classList.remove("listening");
    listenText.textContent = "ëŒ€ê¸° ì¤‘â€¦";
    micBadge.textContent = "ë§ˆì´í¬: ì¤€ë¹„";
    srBadge.textContent  = "ì¸ì‹: ì¤€ë¹„";
  }
}

function pushFinalLine(line){
  if(!line) return;
  finalLines.push(line);
  if(finalLines.length > MAX_LINES) finalLines.shift();
  finalBox.value = finalLines.join("\n");
}

function clearAll(){
  interimBox.value = "";
  finalLines = [];
  finalBox.value = "";
  coachBox.value = "";
}

/* ---------------------------
  SpeechRecognition (ëª¨ë°”ì¼ ì•ˆì • ë²„ì „)
  âœ… í•µì‹¬ ìˆ˜ì •
  - continuous = false
  - onend ìë™ ì¬ì‹œì‘ ì œê±°
  - getUserMedia() ì‚¬ìš© ì•ˆ í•¨ (ì¶©ëŒ ë°©ì§€)
---------------------------- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recog = null;

function buildRecognizer(){
  const r = new SpeechRecognition();
  r.lang = "ko-KR";
  r.interimResults = true;

  // âœ… ëª¨ë°”ì¼ì—ì„œ continuousëŠ” ë¶ˆì•ˆì • -> ë„ê¸°
  r.continuous = false;

  r.onstart = () => {
    srBadge.textContent = "ì¸ì‹: ì§„í–‰ì¤‘";
    micBadge.textContent = "ë§ˆì´í¬: ì‚¬ìš©ì¤‘";
  };

  r.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      const txt = (res[0] && res[0].transcript) ? res[0].transcript : "";
      if (res.isFinal) {
        const cleaned = txt.trim();
        if (cleaned) {
          pushFinalLine(cleaned);
          if (toggleAI.checked) scheduleCoach();
        }
      } else {
        interim += txt;
      }
    }
    interimBox.value = interim.trim();
  };

  r.onerror = (e) => {
    srBadge.textContent = "ì¸ì‹: ì˜¤ë¥˜";
    console.log("Speech error:", e);
    // ëª¨ë°”ì¼ì—ì„œ í”í•œ ì—ëŸ¬ íŒíŠ¸
    if (e && e.error === "not-allowed") {
      alert("ë§ˆì´í¬ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì–´ ìˆì–´ìš”. ì£¼ì†Œì°½ ìë¬¼ì‡  â†’ ê¶Œí•œ â†’ ë§ˆì´í¬ í—ˆìš© í›„ ìƒˆë¡œê³ ì¹¨!");
    }
  };

  // âœ… ìë™ ì¬ì‹œì‘(ëª¨ë°”ì¼ì—ì„œ ë§ê°€ì§) ì œê±°
  r.onend = () => {
    srBadge.textContent = "ì¸ì‹: ì¢…ë£Œë¨";
    micBadge.textContent = "ë§ˆì´í¬: ì¤€ë¹„";
    setListening(false);

    // ì‚¬ìš©ìê°€ ê³„ì† ë“£ê¸° ì›í•˜ë©´, 'Start'ë¥¼ ë‹¤ì‹œ ëˆ„ë¥´ê²Œ ìœ ë„ (ê°€ì¥ ì•ˆì •)
    if (running) {
      running = false;
      btnStart.disabled = false;
      btnStop.disabled = true;
    }
  };

  return r;
}

async function start(){
  if (running) return;

  if (!SpeechRecognition) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome ê¶Œì¥)");
    return;
  }

  running = true;
  btnStart.disabled = true;
  btnStop.disabled = false;
  setListening(true);

  recog = buildRecognizer();

  try {
    recog.start();
  } catch (e) {
    console.log(e);
    running = false;
    btnStart.disabled = false;
    btnStop.disabled = true;
    setListening(false);
    alert("ìŒì„±ì¸ì‹ì„ ì‹œì‘í•˜ì§€ ëª»í–ˆì–´ìš”. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ Startë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
  }
}

function stop(){
  running = false;
  btnStart.disabled = false;
  btnStop.disabled = true;
  setListening(false);

  try{
    if(recog) recog.stop();
  }catch{}

  interimBox.value = "";
}

btnStart.addEventListener("click", start);
btnStop.addEventListener("click", stop);
btnClear.addEventListener("click", clearAll);

/* ---------------------------
  AI ì½”ì¹˜ í˜¸ì¶œ
---------------------------- */
function scheduleCoach(){
  if(aiTimer) clearTimeout(aiTimer);
  aiTimer = setTimeout(() => callCoach(), AI_DEBOUNCE_MS);
}

async function callCoach(){
  const text = finalLines.join("\n").trim();
  if(!text) return;

  coachBox.value = "ì½”ì¹­ ìƒì„± ì¤‘â€¦";
  try{
    const res = await fetch("/api/coach", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ text, tone, length })
    });

    const data = await res.json();

    if(!data.ok){
      coachBox.value = "ì˜¤ë¥˜: " + (data.error || "unknown");
      return;
    }

    const c = data.coach;
    const out =
`[ìš”ì•½]
- ${c.summary}

[í†µì°°]
- ${c.insight || ""}

[ë‹¤ìŒ í–‰ë™ 3ê°œ]
- 1) ${c.actions?.[0] || ""}
- 2) ${c.actions?.[1] || ""}
- 3) ${c.actions?.[2] || ""}

[í•œ ì¤„]
- ${c.one_liner || ""}`;

    coachBox.value = out.trim();

  }catch(e){
    coachBox.value = "ì˜¤ë¥˜: ë„¤íŠ¸ì›Œí¬/ì„œë²„ ë¬¸ì œ";
  }
}
</script>

</body>
</html>
