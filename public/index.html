<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Silent Coach</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b1020">

  <!-- (ì„ íƒ) iOS ì„¤ì¹˜ ì•„ì´ì½˜/ìŠ¤íƒ€ì¼ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SilentCoach">

  <style>
    :root{
      --bg:#0b1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --text:#e5e7eb;
      --muted:#a7b0c0;
      --line: rgba(255,255,255,.10);
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --primary:#3b82f6;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Apple SD Gothic Neo","ë§‘ì€ ê³ ë”•",sans-serif;
      background: radial-gradient(circle at top left, #11183a 0, var(--bg) 55%, #050814 100%);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      overflow-x:hidden;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }

    h1{
      margin: 0 0 12px;
      font-size: clamp(28px, 5vw, 44px);
      letter-spacing: .5px;
      text-align:center;
      opacity:.95;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      margin: 12px 0 10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border: 1px solid var(--line);
      background: var(--panel);
      border-radius: 999px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      user-select:none;
    }

    .dot{
      width:10px;height:10px;border-radius:999px;
      background: #64748b;
      box-shadow: 0 0 0 0 rgba(34,197,94,0);
      transition: .2s;
    }

    /* ë“£ëŠ” ì¤‘ íš¨ê³¼ */
    .listening .dot{
      background: var(--ok);
      animation: pulse 1.1s infinite;
    }
    @keyframes pulse{
      0% { box-shadow: 0 0 0 0 rgba(34,197,94,.55); }
      70% { box-shadow: 0 0 0 10px rgba(34,197,94,0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }

    .btn{
      border:0;
      padding: 12px 16px;
      border-radius: 14px;
      background: var(--panel);
      color: var(--text);
      font-weight: 700;
      cursor:pointer;
      border: 1px solid var(--line);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      transition: transform .05s ease, background .2s ease, border .2s ease;
      min-width: 92px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: rgba(59,130,246,.22); border-color: rgba(59,130,246,.35); }
    .btn.danger{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.35); }
    .btn.ghost{ background: rgba(255,255,255,.03); }

    .toggle{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-radius: 14px;
      background: var(--panel);
      border:1px solid var(--line);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      cursor:pointer;
      user-select:none;
    }
    .toggle input{ width:18px;height:18px; }

    .help{
      max-width: 720px;
      margin: 0 auto 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }
    .help ul{ margin: 10px 0 0; padding-left: 18px; }
    .help li{ margin: 4px 0; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .card h3{
      margin:0 0 8px;
      font-size: 14px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      font-weight: 700;
      letter-spacing:.2px;
    }

    .box{
      width:100%;
      min-height: 110px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      padding: 12px;
      color: var(--text);
      font-size: 18px;
      line-height: 1.5;
      outline:none;
      resize: vertical;
    }

    .box.small{ min-height: 90px; font-size: 17px; }

    .statusRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-weight: 700;
      white-space:nowrap;
    }

    .footer{
      text-align:center;
      margin-top: 16px;
      color: rgba(167,176,192,.75);
      font-size: 12px;
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap" id="appRoot">
    <h1>Silent Coach</h1>

    <div class="toolbar">
      <div class="pill" id="listenPill" aria-live="polite">
        <span class="dot"></span>
        <span id="listenText">ëŒ€ê¸° ì¤‘â€¦</span>
      </div>

      <button class="btn primary" id="btnStart">Start</button>
      <button class="btn danger" id="btnStop" disabled>Stop</button>
      <button class="btn ghost" id="btnClear">Clear</button>

      <label class="toggle" title="AI ì½”ì¹­ì„ ì¼œë©´ ë§ì´ ëë‚œ í›„ ìë™ìœ¼ë¡œ ì½”ì¹­ì„ ìƒì„±í•©ë‹ˆë‹¤.">
        <input type="checkbox" id="toggleAI" checked />
        <span>AI ì½”ì¹˜ ON</span>
      </label>
    </div>

    <div class="help">
      <ul>
        <li>ë§í•˜ëŠ” ë™ì•ˆ ì¦‰ì‹œ ìë§‰(interim) í‘œì‹œ</li>
        <li>ë§ì´ ëë‚˜ë©´ ìµœì¢… ì „ì‚¬(final) ëˆ„ì </li>
        <li>ìµœì¢… ì „ì‚¬ê°€ ì—°ì†ìœ¼ë¡œ ë“¤ì–´ì™€ë„ AIëŠ” ë””ë°”ìš´ìŠ¤ë¡œ 1íšŒë§Œ í˜¸ì¶œ</li>
      </ul>
    </div>

    <div class="grid">
      <div class="card">
        <h3>ğŸ™ï¸ ì‹¤ì‹œê°„ ì „ì‚¬ (interim)</h3>
        <textarea class="box small" id="interimBox" placeholder="ì—¬ê¸°ì— ë§í•œ ë‚´ìš©ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤..." readonly></textarea>
        <div class="statusRow">
          <span class="badge" id="micBadge">ë§ˆì´í¬: ì¤€ë¹„</span>
          <span class="badge" id="srBadge">ì¸ì‹: ì¤€ë¹„</span>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ§  ì½”ì¹˜ ë‹µë³€ (í…ìŠ¤íŠ¸)</h3>
        <textarea class="box small" id="coachBox" placeholder="AI ì½”ì¹˜ê°€ ì¼œì ¸ ìˆìœ¼ë©´ ì—¬ê¸°ì— ë‹µë³€ì´ í‘œì‹œë©ë‹ˆë‹¤..." readonly></textarea>
        <div class="statusRow">
          <span class="badge" id="toneBadge">tone: calm</span>
          <span class="badge" id="lenBadge">length: medium</span>
        </div>
      </div>

      <div class="card" style="grid-column:1/-1">
        <h3>âœ… ìµœì¢… ì „ì‚¬ (ìµœê·¼ Nì¤„)</h3>
        <textarea class="box" id="finalBox" placeholder="ìµœì¢… í™•ì •ëœ ë¬¸ì¥ì´ ì—¬ê¸°ì— ìŒ“ì…ë‹ˆë‹¤..." readonly></textarea>
      </div>
    </div>

    <div class="footer">
      í™ˆí™”ë©´ì— ì¶”ê°€ê°€ ì•ˆ ë³´ì´ë©´: ëª¨ë°”ì¼ Chromeì—ì„œ â‹® â†’ â€œí™ˆ í™”ë©´ì— ì¶”ê°€â€
    </div>
  </div>

<script>
/* ---------------------------
  PWA: ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡
---------------------------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js").catch(()=>{});
}

/* ---------------------------
  ìŒì„± ì¸ì‹ (Web Speech API)
  - í˜ì´ì§€ ë¡œë“œì‹œ ë§ˆì´í¬ ìš”ì²­í•˜ì§€ ì•ŠìŒ
  - Start ë²„íŠ¼ ëˆ„ë¥¼ ë•Œë§Œ ì‹œì‘
---------------------------- */
const root = document.getElementById("appRoot");
const listenPill = document.getElementById("listenPill");
const listenText = document.getElementById("listenText");

const btnStart = document.getElementById("btnStart");
const btnStop  = document.getElementById("btnStop");
const btnClear = document.getElementById("btnClear");

const toggleAI = document.getElementById("toggleAI");

const interimBox = document.getElementById("interimBox");
const finalBox   = document.getElementById("finalBox");
const coachBox   = document.getElementById("coachBox");

const micBadge = document.getElementById("micBadge");
const srBadge  = document.getElementById("srBadge");
const toneBadge = document.getElementById("toneBadge");
const lenBadge  = document.getElementById("lenBadge");

// ì˜µì…˜(ì›í•˜ë©´ UIë¡œ ë‚˜ì¤‘ì— ë°”ê¿€ ìˆ˜ ìˆìŒ)
let tone = localStorage.getItem("sc_tone") || "calm";
let length = localStorage.getItem("sc_length") || "medium";
toneBadge.textContent = "tone: " + tone;
lenBadge.textContent = "length: " + length;

let running = false;
let finalLines = [];
const MAX_LINES = 12;

// AI í˜¸ì¶œ ë””ë°”ìš´ìŠ¤
let aiTimer = null;
const AI_DEBOUNCE_MS = 700;

// ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼(Stop ì‹œ ì¢…ë£Œìš©)
let micStream = null;

function setListening(on){
  if(on){
    root.classList.add("listening");
    listenText.textContent = "ë“£ëŠ” ì¤‘â€¦";
    micBadge.textContent = "ë§ˆì´í¬: ì‚¬ìš©ì¤‘";
    srBadge.textContent  = "ì¸ì‹: ì§„í–‰ì¤‘";
  }else{
    root.classList.remove("listening");
    listenText.textContent = "ëŒ€ê¸° ì¤‘â€¦";
    micBadge.textContent = "ë§ˆì´í¬: ì¤€ë¹„";
    srBadge.textContent  = "ì¸ì‹: ì¤€ë¹„";
  }
}

function pushFinalLine(line){
  if(!line) return;
  finalLines.push(line);
  if(finalLines.length > MAX_LINES) finalLines.shift();
  finalBox.value = finalLines.join("\n");
}

function clearAll(){
  interimBox.value = "";
  finalLines = [];
  finalBox.value = "";
  coachBox.value = "";
}

// SpeechRecognition ì¤€ë¹„
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recog = null;

function buildRecognizer(){
  const r = new SpeechRecognition();
  r.lang = "ko-KR";
  r.interimResults = true;
  r.continuous = true;

  r.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      const txt = (res[0] && res[0].transcript) ? res[0].transcript : "";
      if (res.isFinal) {
        const cleaned = txt.trim();
        if (cleaned) {
          pushFinalLine(cleaned);
          if (toggleAI.checked) scheduleCoach();
        }
      } else {
        interim += txt;
      }
    }
    interimBox.value = interim.trim();
  };

  r.onerror = (e) => {
    srBadge.textContent = "ì¸ì‹: ì˜¤ë¥˜";
    console.log("Speech error:", e);
  };

  r.onend = () => {
    // running ìƒíƒœì¸ë° ì¤‘ê°„ì— ëŠê¸°ë©´ ìë™ ì¬ì‹œì‘(ëª¨ë°”ì¼ì€ ìƒí™©ì— ë”°ë¼ ëŠê¸¸ ìˆ˜ ìˆìŒ)
    if (running) {
      try { r.start(); } catch {}
    }
  };

  return r;
}

async function ensureMicOnce(){
  // â€œStartâ€ ëˆ„ë¥¼ ë•Œë§Œ ë§ˆì´í¬ ê¶Œí•œì„ ìš”ì²­í•˜ë„ë¡ í•¨
  try{
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    micBadge.textContent = "ë§ˆì´í¬: í—ˆìš©ë¨";
  }catch(e){
    micBadge.textContent = "ë§ˆì´í¬: ì°¨ë‹¨ë¨";
    throw e;
  }
}

async function start(){
  if (running) return;
  if (!SpeechRecognition) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome ê¶Œì¥)");
    return;
  }

  // âœ… ì‚¬ìš©ì ì œìŠ¤ì²˜(Start í´ë¦­)ì—ì„œë§Œ ê¶Œí•œ ìš”ì²­ â†’ íŒì—… ë°˜ë³µ ê°ì†Œì— ë„ì›€
  try{
    await ensureMicOnce();
  }catch(e){
    alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    return;
  }

  running = true;
  btnStart.disabled = true;
  btnStop.disabled = false;
  setListening(true);

  recog = buildRecognizer();
  try { recog.start(); } catch {}
}

function stop(){
  running = false;
  btnStart.disabled = false;
  btnStop.disabled = true;
  setListening(false);

  try{
    if(recog) recog.stop();
  }catch{}

  // ë§ˆì´í¬ íŠ¸ë™ ì¢…ë£Œ(ë¶ˆí•„ìš”í•œ ì ìœ  ë°©ì§€)
  if(micStream){
    micStream.getTracks().forEach(t => t.stop());
    micStream = null;
  }

  interimBox.value = "";
}

btnStart.addEventListener("click", start);
btnStop.addEventListener("click", stop);
btnClear.addEventListener("click", clearAll);

/* ---------------------------
  AI ì½”ì¹˜ í˜¸ì¶œ
---------------------------- */
function scheduleCoach(){
  if(aiTimer) clearTimeout(aiTimer);
  aiTimer = setTimeout(() => callCoach(), AI_DEBOUNCE_MS);
}

async function callCoach(){
  const text = finalLines.join("\n").trim();
  if(!text) return;

  coachBox.value = "ì½”ì¹­ ìƒì„± ì¤‘â€¦";
  try{
    const res = await fetch("/api/coach", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ text, tone, length })
    });
    const data = await res.json();
    if(!data.ok){
      coachBox.value = "ì˜¤ë¥˜: " + (data.error || "unknown");
      return;
    }

    const c = data.coach;
    const out =
`[ìš”ì•½]
- ${c.summary}

[í†µì°°]
- ${c.insight || ""}

[ë‹¤ìŒ í–‰ë™ 3ê°œ]
- 1) ${c.actions?.[0] || ""}
- 2) ${c.actions?.[1] || ""}
- 3) ${c.actions?.[2] || ""}

[í•œ ì¤„]
- ${c.one_liner || ""}`;

    coachBox.value = out.trim();

  }catch(e){
    coachBox.value = "ì˜¤ë¥˜: ë„¤íŠ¸ì›Œí¬/ì„œë²„ ë¬¸ì œ";
  }
}
</script>

</body>
</html>
