<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Silent Coach</title>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(circle at top left, #1e3a8a 0, #020617 55%, #000 100%);
      color:#e5e7eb;
    }
    .wrap{max-width:960px;margin:0 auto;padding:18px}
    h1{margin:10px 0 18px;text-align:center;letter-spacing:1px}
    .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;align-items:center}
    button{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:#fff;
      padding:14px 20px;
      border-radius:16px;
      font-weight:800;
      min-width:160px;
      cursor:pointer;
    }
    button.primary{background:rgba(37,99,235,.9)}
    button.danger{background:rgba(185,28,28,.75)}
    button:disabled{opacity:.45;cursor:not-allowed}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-weight:700;
    }
    .grid{display:grid;gap:14px;margin-top:16px}
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:14px;
    }
    .label{opacity:.9;font-weight:900;margin-bottom:10px}
    textarea{
      width:100%;
      min-height:120px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.35);
      color:#e5e7eb;
      padding:12px;
      outline:none;
      font-size:16px;
      line-height:1.5;
      resize:vertical;
    }
    .small{opacity:.8;font-size:13px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    select{
      background:rgba(255,255,255,.06);
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Silent Coach</h1>

    <div class="row">
      <button class="primary" id="btnStart">üé§ Start</button>
      <button class="danger" id="btnStop">‚õî Stop</button>
      <button id="btnClear">Clear</button>

      <span class="pill" id="statusPill">‚è∏Ô∏è ÎåÄÍ∏∞</span>
      <span class="pill">
        <input type="checkbox" id="aiOn" checked />
        <label for="aiOn">AI ÏΩîÏπò ON</label>
      </span>
    </div>

    <div class="row" style="margin-top:10px">
      <select id="tone">
        <option value="calm">tone: calm</option>
        <option value="friendly">tone: friendly</option>
        <option value="strict">tone: strict</option>
      </select>
      <select id="len">
        <option value="short">length: short</option>
        <option value="medium" selected>length: medium</option>
        <option value="long">length: long</option>
      </select>
      <button id="btnPing">üîé Ping ÌÖåÏä§Ìä∏</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="label">üéß Ïã§ÏãúÍ∞Ñ Ï†ÑÏÇ¨ (interim)</div>
        <textarea id="interim" placeholder="Ïó¨Í∏∞Ïóê ÎßêÌïú ÎÇ¥Ïö©Ïù¥ Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÌëúÏãúÎê©ÎãàÎã§..." readonly></textarea>
        <div class="small mono" id="micState">mic: Ï§ÄÎπÑ</div>
      </div>

      <div class="card">
        <div class="label">üß† ÏΩîÏπò ÎãµÎ≥Ä (ÌÖçÏä§Ìä∏)</div>
        <textarea id="coach" placeholder="AI ÏΩîÏπòÍ∞Ä ÏºúÏ†∏ ÏûàÏúºÎ©¥ Ïó¨Í∏∞Ïóê ÎãµÎ≥ÄÏù¥ ÌëúÏãúÎê©ÎãàÎã§..." readonly></textarea>
        <div class="small mono" id="aiState">ai: Ï§ÄÎπÑ</div>
      </div>
    </div>
  </div>

<script>
(() => {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");
  const btnClear = document.getElementById("btnClear");
  const btnPing  = document.getElementById("btnPing");

  const statusPill = document.getElementById("statusPill");
  const interimBox = document.getElementById("interim");
  const coachBox   = document.getElementById("coach");
  const micState   = document.getElementById("micState");
  const aiState    = document.getElementById("aiState");

  const aiOn  = document.getElementById("aiOn");
  const tone  = document.getElementById("tone");
  const len   = document.getElementById("len");

  let rec = null;
  let running = false;

  // ‚úÖ ÏµúÏ¢Ö Ï†ÑÏÇ¨ ÎàÑÏ†Å
  let finalText = "";
  // ‚úÖ ÎîîÎ∞îÏö¥Ïä§(Îßê ÎÅùÎÇòÍ≥† Ìïú Î≤àÎßå ÏΩîÏπò Ìò∏Ï∂ú)
  let coachTimer = null;

  function setStatus(text) {
    statusPill.textContent = text;
  }

  function safeAppendInterim(t) {
    // ÌôîÎ©¥Ïóê ÎÑàÎ¨¥ Í∏∏Í≤å ÏåìÏù¥ÏßÄ ÏïäÍ≤å
    const s = (t || "").slice(-500);
    interimBox.value = s;
  }

  async function callCoach(text) {
    if (!aiOn.checked) return;
    if (!text.trim()) return;

    aiState.textContent = "ai: Ìò∏Ï∂úÏ§ë...";
    coachBox.value = "‚åõ ÏΩîÏπò ÏÉùÍ∞ÅÏ§ë...";

    try {
      const r = await fetch("/api/coach", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, tone: tone.value, length: len.value })
      });

      const data = await r.json().catch(() => ({}));

      if (!r.ok) {
        const msg = data?.detail || data?.error || ("HTTP " + r.status);
        coachBox.value = "‚ùå ÏΩîÏπò Ïò§Î•ò: " + msg;
        aiState.textContent = "ai: Ïò§Î•ò";
        console.error("coach error:", data);
        return;
      }

      coachBox.value = data.reply || "(ÏùëÎãµ ÏóÜÏùå)";
      aiState.textContent = "ai: ÏôÑÎ£å";
    } catch (e) {
      coachBox.value = "‚ùå ÏΩîÏπò Ìò∏Ï∂ú Ïã§Ìå®: " + (e?.message || e);
      aiState.textContent = "ai: Ïã§Ìå®";
      console.error(e);
    }
  }

  function scheduleCoach() {
    clearTimeout(coachTimer);
    // Îßê Î©àÏ∂ò Îí§ 900ms ÌõÑÏóê Ìïú Î≤àÎßå Ìò∏Ï∂ú
    coachTimer = setTimeout(() => {
      callCoach(finalText);
    }, 900);
  }

  function start() {
    if (!SpeechRecognition) {
      setStatus("‚ùå Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏùåÏÑ±Ïù∏Ïãù ÎØ∏ÏßÄÏõê");
      return;
    }

    if (running) return;

    rec = new SpeechRecognition();
    rec.lang = "ko-KR";
    rec.interimResults = true;

    // ‚úÖ Î™®Î∞îÏùºÏóêÏÑú ÎÅäÍ≤®ÎèÑ Í≥ÑÏÜç Ïù¥Ïñ¥ÏßÄÍ≤å
    rec.continuous = true;

    rec.onstart = () => {
      running = true;
      setStatus("üü¢ Îì£ÎäîÏ§ë...");
      micState.textContent = "mic: Îì£ÎäîÏ§ë";
      aiState.textContent = "ai: Ï§ÄÎπÑ";
    };

    rec.onerror = (e) => {
      console.error("rec error:", e);
      setStatus("‚ö†Ô∏è ÏùåÏÑ± Ïò§Î•ò: " + (e?.error || "unknown"));
      micState.textContent = "mic: Ïò§Î•ò";
    };

    rec.onend = () => {
      running = false;
      setStatus("‚è∏Ô∏è Ï§ëÏßÄÎê®");
      micState.textContent = "mic: Ï§ëÏßÄ";
    };

    rec.onresult = (ev) => {
      let interim = "";
      for (let i = ev.resultIndex; i < ev.results.length; i++) {
        const txt = ev.results[i][0].transcript;
        if (ev.results[i].isFinal) {
          finalText += (finalText ? " " : "") + txt.trim();
        } else {
          interim += txt;
        }
      }

      // ‚úÖ Ïã§ÏãúÍ∞ÑÏùÄ interimÎßå ÌëúÏãú(Î∞òÎ≥µ ‚ÄúÏßÄÍ∏à ÏßÄÍ∏à‚Ä¶‚Äù ÏôÑÌôî)
      safeAppendInterim(interim || finalText);

      // ‚úÖ finalÏù¥ Ï°∞Í∏àÏù¥ÎùºÎèÑ ÎäòÏóàÏúºÎ©¥ ÏΩîÏπò ÏòàÏïΩ
      scheduleCoach();
    };

    rec.start();
  }

  function stop() {
    try { rec && rec.stop(); } catch {}
  }

  btnStart.onclick = () => start();
  btnStop.onclick  = () => stop();
  btnClear.onclick = () => {
    finalText = "";
    interimBox.value = "";
    coachBox.value = "";
    aiState.textContent = "ai: Ï§ÄÎπÑ";
    setStatus("‚è∏Ô∏è ÎåÄÍ∏∞");
  };

  btnPing.onclick = async () => {
    aiState.textContent = "ai: ping...";
    try {
      const r = await fetch("/api/ping");
      const d = await r.json();
      coachBox.value = "‚úÖ ping ok: " + JSON.stringify(d);
      aiState.textContent = "ai: ping ok";
    } catch (e) {
      coachBox.value = "‚ùå ping Ïã§Ìå®: " + (e?.message || e);
      aiState.textContent = "ai: ping fail";
    }
  };

})();
</script>
</body>
</html>
