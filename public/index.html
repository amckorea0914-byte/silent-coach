<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Silent Coach (Text Only)</title>

  <!-- âœ… PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b1020">

  <style>
    body {
      margin:0;
      font-family:system-ui,-apple-system,"Apple SD Gothic Neo","ë§‘ì€ ê³ ë”•",sans-serif;
      background:#0b1020;
      color:#e5e7eb;
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 26px; }
    h1 { margin:0 0 10px; font-size: 34px; }

    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }

    .status {
      padding: 7px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 12px;
    }
    .dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px; background:#94a3b8; }
    .listening .dot { background:#22c55e; }
    .thinking .dot { background:#f59e0b; }
    .error .dot { background:#ef4444; }

    button {
      padding: 10px 14px;
      border: 0;
      border-radius: 10px;
      background: #2563eb;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    button.secondary { background:#334155; }
    button.danger { background:#ef4444; }
    button:disabled { opacity:.55; cursor:not-allowed; }

    label.toggle {
      display:flex;
      align-items:center;
      gap:8px;
      padding: 9px 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      font-size: 13px;
    }
    input[type="checkbox"] { width:18px; height:18px; }

    .hint { font-size: 12px; opacity:.75; margin-top:10px; line-height:1.5; }

    .card {
      margin-top: 16px;
      padding: 16px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .label { font-size: 12px; opacity:.85; margin-bottom: 8px; }
    .big {
      font-size: 18px;
      line-height: 1.7;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .muted { opacity:.7; }

    .scrollBox {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .cols { display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width: 980px) {
      .cols { grid-template-columns:1fr 1fr; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Silent Coach</h1>

  <div class="row">
    <span id="status" class="status"><span class="dot"></span><span id="statusText">ëŒ€ê¸° ì¤‘</span></span>

    <button id="btnStart">Start</button>
    <button id="btnStop" class="danger" disabled>Stop</button>
    <button id="btnClear" class="secondary">Clear</button>

    <label class="toggle">
      <input id="toggleCoach" type="checkbox" checked />
      AI ì½”ì¹˜ ON
    </label>
  </div>

  <div class="hint">
    â€¢ ë§í•˜ëŠ” ë™ì•ˆ ì¦‰ì‹œ ìë§‰(interim) í‘œì‹œ<br/>
    â€¢ ë§ì´ ëë‚˜ë©´ ìµœì¢… ì „ì‚¬(final) ëˆ„ì <br/>
    â€¢ ìµœì¢… ì „ì‚¬ê°€ ì—°ì†ìœ¼ë¡œ ë“¤ì–´ì™€ë„ AIëŠ” 0.6ì´ˆ ë””ë°”ìš´ìŠ¤ë¡œ 1íšŒë§Œ í˜¸ì¶œ
  </div>

  <div class="cols">
    <div class="card">
      <div class="label">ğŸ™ ì‹¤ì‹œê°„ ì „ì‚¬ (interim)</div>
      <div id="liveCaption" class="big muted">ì—¬ê¸°ì— ë§í•œ ë‚´ìš©ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤â€¦</div>
    </div>

    <div class="card">
      <div class="label">ğŸ¤– ì½”ì¹˜ ë‹µë³€ (í…ìŠ¤íŠ¸)</div>
      <div id="coachReply" class="big muted">AI ì½”ì¹˜ê°€ ì¼œì ¸ ìˆìœ¼ë©´ ì—¬ê¸°ì— ë‹µë³€ì´ í‘œì‹œë©ë‹ˆë‹¤â€¦</div>
    </div>
  </div>

  <div class="card">
    <div class="label">âœ… ìµœì¢… ì „ì‚¬ (ìµœê·¼ Nì¤„)</div>
    <div id="finalText" class="big muted scrollBox">ìµœì¢… í™•ì •ëœ ë¬¸ì¥ì´ ì—¬ê¸°ì— ìŒ“ì…ë‹ˆë‹¤â€¦</div>
  </div>
</div>

<script>
  // âœ… PWA: Service Worker ë“±ë¡
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw.js").catch(() => {});
  }

  /* ===================== ì„¤ì • ===================== */
  const MAX_FINAL_LINES = 30;

  /* ===================== ìš”ì†Œ ===================== */
  const statusEl = document.getElementById("status");
  const statusTextEl = document.getElementById("statusText");
  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");
  const btnClear = document.getElementById("btnClear");
  const toggleCoachEl = document.getElementById("toggleCoach");

  const liveCaptionEl = document.getElementById("liveCaption");
  const finalTextEl   = document.getElementById("finalText");
  const coachReplyEl  = document.getElementById("coachReply");

  /* ===================== ìœ í‹¸/ìƒíƒœ ===================== */
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let running = false;
  let lastFinal = "";
  let restartTimer = null;
  let thinkingLock = false;

  // âœ… ë””ë°”ìš´ìŠ¤ íƒ€ì´ë¨¸(í­ì£¼ ë°©ì§€)
  let aiTimer = null;

  function setStatus(cls, text) {
    statusEl.className = "status " + (cls || "");
    statusTextEl.textContent = text;
  }

  function setLive(text) {
    liveCaptionEl.classList.remove("muted");
    liveCaptionEl.textContent = text || "â€¦";
  }

  function setCoach(text) {
    coachReplyEl.classList.remove("muted");
    coachReplyEl.textContent = text;
  }

  function appendFinal(text) {
    finalTextEl.classList.remove("muted");

    let lines = [];
    const cur = finalTextEl.textContent.trim();
    if (cur && !cur.includes("ìµœì¢… í™•ì •ëœ ë¬¸ì¥ì´")) {
      lines = cur.split("\n");
    }

    lines.push(text);
    if (lines.length > MAX_FINAL_LINES) {
      lines = lines.slice(lines.length - MAX_FINAL_LINES);
    }

    finalTextEl.textContent = lines.join("\n");
    finalTextEl.scrollTop = finalTextEl.scrollHeight;
  }

  function normalizeFinal(s) {
    return (s || "").replace(/\s+/g, " ").trim();
  }

  function localCoach(text) {
    const t = text.trim();
    if (!t) return "ì¡°ê¸ˆ ë” ë§í•´ì¤„ë˜?";
    const short = t.length > 60 ? t.slice(0,60) + "â€¦" : t;
    return `ìš”ì•½: ${short}
ë‹¤ìŒ í–‰ë™: í•œ ë¬¸ì¥ ëª©í‘œë¡œ ë‹¤ì‹œ ì ì–´ë´.
í™•ì¸: ì´ê±¸ í†µí•´ ì–»ê³  ì‹¶ì€ ê²°ê³¼ëŠ” ë­ì•¼?`;
  }

  // âœ… ë””ë°”ìš´ìŠ¤ ìŠ¤ì¼€ì¤„ëŸ¬: ë§ˆì§€ë§‰ final ê¸°ì¤€ 0.6ì´ˆ í›„ 1íšŒë§Œ AI í˜¸ì¶œ
  function scheduleAI(text) {
    clearTimeout(aiTimer);
    aiTimer = setTimeout(() => {
      if (!thinkingLock) askAI(text);
    }, 600);
  }

  async function askAI(finalText) {
    const prompt = normalizeFinal(finalText);
    if (!prompt) {
      setCoach("ë§í•œ ë‚´ìš©ì´ ë¹„ì–´ìˆì–´. ë‹¤ì‹œ ë§í•´ì¤˜.");
      return;
    }

    try {
      thinkingLock = true;
      setStatus("thinking", "ë‹µë³€ ìƒì„± ì¤‘â€¦");
      setCoach("ë‹µë³€ ìƒì„± ì¤‘â€¦");

      // âœ… ë°°í¬/ë¡œì»¬ ê³µí†µ: ìƒëŒ€ê²½ë¡œë§Œ ì‚¬ìš©
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: prompt })
      });

      const data = await res.json();
      const reply = (data.reply || "").trim();

      setCoach(reply || "ì‘ë‹µì´ ë¹„ì–´ìˆì–´. ë‹¤ì‹œ ë§í•´ì¤˜.");
      if (running) setStatus("listening", "ë“£ëŠ” ì¤‘â€¦");
      else setStatus("", "ëŒ€ê¸° ì¤‘");
    } catch (e) {
      setCoach("ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì„œë²„(CMD) ë˜ëŠ” ë°°í¬ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì¤˜.");
      setStatus("error", "ì„œë²„ ì˜¤ë¥˜");
    } finally {
      thinkingLock = false;
    }
  }

  /* ===================== STT êµ¬ì„± ===================== */
  function buildRecognition() {
    const r = new SpeechRecognition();
    r.lang = "ko-KR";
    r.continuous = true;
    r.interimResults = true;

    r.onstart = () => setStatus("listening", "ë“£ëŠ” ì¤‘â€¦");
    r.onerror = () => setStatus("error", "ì¸ì‹ ì˜¤ë¥˜");

    r.onend = () => {
      if (!running) {
        setStatus("", "ëŒ€ê¸° ì¤‘");
        return;
      }
      setStatus("thinking", "ì¬ì—°ê²° ì¤‘â€¦");
      clearTimeout(restartTimer);
      restartTimer = setTimeout(() => {
        try { r.start(); } catch {}
      }, 250);
    };

    r.onresult = (e) => {
      let interim = "";
      let finalText = "";

      for (let i = e.resultIndex; i < e.results.length; i++) {
        const txt = (e.results[i][0].transcript || "").trim();
        if (!txt) continue;
        if (e.results[i].isFinal) finalText += (finalText ? " " : "") + txt;
        else interim += (interim ? " " : "") + txt;
      }

      if (interim) setLive(interim);
      else if (finalText) setLive(finalText);

      const cleanedFinal = normalizeFinal(finalText);
      if (!cleanedFinal || cleanedFinal === lastFinal) return;

      lastFinal = cleanedFinal;
      appendFinal(cleanedFinal);

      if (toggleCoachEl.checked) {
        scheduleAI(cleanedFinal);
      } else {
        setCoach(localCoach(cleanedFinal));
      }
    };

    return r;
  }

  /* ===================== ì»¨íŠ¸ë¡¤ ===================== */
  function start() {
    if (running) return;

    if (!SpeechRecognition) {
      setStatus("error", "ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ");
      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” SpeechRecognitionì„ ì§€ì›í•˜ì§€ ì•Šì•„. Chrome ìµœì‹  ë²„ì „ ê¶Œì¥!");
      return;
    }

    // âœ… ë§ˆì´í¬ ê¶Œí•œ ì•ˆë‚´
    setCoach("ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì¤˜. (ì£¼ì†Œì°½ ì™¼ìª½ ğŸ”’/â“˜ ì•„ì´ì½˜ì—ì„œ ë§ˆì´í¬ í—ˆìš©)");

    running = true;
    btnStart.disabled = true;
    btnStop.disabled = false;

    if (!recognition) recognition = buildRecognition();

    try { recognition.start(); }
    catch { setTimeout(() => { try { recognition.start(); } catch {} }, 300); }
  }

  function stop() {
    running = false;
    btnStart.disabled = false;
    btnStop.disabled = true;

    clearTimeout(restartTimer);
    clearTimeout(aiTimer);

    if (recognition) {
      try { recognition.stop(); } catch {}
      recognition = null;
    }

    setStatus("", "ëŒ€ê¸° ì¤‘");
  }

  function clearAll() {
    liveCaptionEl.textContent = "ì—¬ê¸°ì— ë§í•œ ë‚´ìš©ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤â€¦";
    liveCaptionEl.classList.add("muted");

    finalTextEl.textContent = "ìµœì¢… í™•ì •ëœ ë¬¸ì¥ì´ ì—¬ê¸°ì— ìŒ“ì…ë‹ˆë‹¤â€¦";
    finalTextEl.classList.add("muted");

    coachReplyEl.textContent = "AI ì½”ì¹˜ê°€ ì¼œì ¸ ìˆìœ¼ë©´ ì—¬ê¸°ì— ë‹µë³€ì´ í‘œì‹œë©ë‹ˆë‹¤â€¦";
    coachReplyEl.classList.add("muted");

    lastFinal = "";
  }

  btnStart.onclick = start;
  btnStop.onclick  = stop;
  btnClear.onclick = clearAll;

  window.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
      e.preventDefault();
      running ? stop() : start();
    }
  });

  toggleCoachEl.addEventListener("change", () => {
    setCoach(toggleCoachEl.checked ? "AI ì½”ì¹˜ ON" : "AI ì½”ì¹˜ OFF (ë¡œì»¬ ê·œì¹™ ëª¨ë“œ)");
  });
</script>
</body>
</html>
