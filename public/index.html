<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Silent Coach</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b1020">

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Apple SD Gothic Neo","Malgun Gothic",sans-serif;
      background: radial-gradient(circle at top, #182a5a 0%, #0b1020 55%, #070a12 100%);
      color:#e5e7eb;
    }
    .wrap{max-width:960px;margin:0 auto;padding:20px 16px 40px}
    h1{margin:10px 0 18px;text-align:center;letter-spacing:.5px}
    .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:14px}
    button{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#fff;
      padding:12px 18px;
      border-radius:18px;
      font-weight:700;
      min-width:140px;
    }
    button.primary{background:rgba(37,99,235,.75)}
    button.danger{background:rgba(220,38,38,.55)}
    button:disabled{opacity:.45}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 14px;border-radius:999px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      font-weight:700;
    }
    .dot{width:10px;height:10px;border-radius:50%;background:#9ca3af}
    .listening .dot{background:#22c55e; box-shadow:0 0 18px rgba(34,197,94,.55)}
    .grid{display:grid;gap:12px;margin-top:12px}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:20px;
      padding:14px;
      box-shadow:0 14px 40px rgba(0,0,0,.25);
    }
    .label{font-weight:800;margin-bottom:10px;opacity:.95}
    textarea{
      width:100%;
      min-height:160px;
      resize:vertical;
      border-radius:16px;
      padding:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:#e5e7eb;
      outline:none;
      font-size:15px;
      line-height:1.5;
    }
    .small{opacity:.8;font-size:13px;margin-top:8px}
    .switch{
      display:flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:16px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-weight:800;
    }
    .status{
      margin:10px auto 0;
      max-width:960px;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      font-size:13px;
      opacity:.9;
    }
  </style>
</head>

<body>
  <div class="wrap" id="appRoot">
    <h1>Silent Coach</h1>

    <div class="row">
      <div class="pill" id="listenPill"><span class="dot"></span><span id="listenText">ëŒ€ê¸° ì¤‘â€¦</span></div>

      <button class="primary" id="btnStart">ğŸ¤ Start</button>
      <button class="danger" id="btnStop" disabled>â›” Stop</button>
      <button id="btnClear">ğŸ§¹ Clear</button>

      <label class="switch">
        <input type="checkbox" id="toggleAI" checked>
        AI ì½”ì¹˜ ON
      </label>

      <button id="btnTest">ğŸ§ª ì½”ì¹˜ í…ŒìŠ¤íŠ¸</button>
    </div>

    <div class="status" id="statusLine">ìƒíƒœ: ì¤€ë¹„</div>

    <div class="grid">
      <div class="card">
        <div class="label">ğŸ—£ï¸ ì‹¤ì‹œê°„ ì „ì‚¬ (interim)</div>
        <textarea id="interimBox" placeholder="ë§í•˜ë©´ ì—¬ê¸°ì— ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤â€¦" readonly></textarea>
        <div class="small" id="micBadge">ë§ˆì´í¬: ì¤€ë¹„</div>
        <div class="small" id="srBadge">ì¸ì‹: ì¤€ë¹„</div>
      </div>

      <div class="card">
        <div class="label">ğŸ§  ì½”ì¹˜ ë‹µë³€ (í…ìŠ¤íŠ¸)</div>
        <textarea id="coachBox" placeholder="AI ì½”ì¹˜ê°€ ì—¬ê¸° ë‹µë³€í•©ë‹ˆë‹¤â€¦" readonly></textarea>
        <div class="small">tone: <span id="toneBadge"></span> / length: <span id="lenBadge"></span></div>
      </div>

      <div class="card" style="grid-column:1/-1">
        <div class="label">âœ… ìµœì¢… ì „ì‚¬ (final ëˆ„ì )</div>
        <textarea id="finalBox" placeholder="í™•ì •ëœ ë¬¸ì¥ì´ ì—¬ê¸°ì— ëˆ„ì ë©ë‹ˆë‹¤â€¦" readonly></textarea>
      </div>
    </div>
  </div>

<script>
/* PWA: ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js").catch(()=>{});
}

const root = document.getElementById("appRoot");
const listenText = document.getElementById("listenText");
const btnStart = document.getElementById("btnStart");
const btnStop  = document.getElementById("btnStop");
const btnClear = document.getElementById("btnClear");
const btnTest  = document.getElementById("btnTest");

const toggleAI  = document.getElementById("toggleAI");
const interimBox = document.getElementById("interimBox");
const finalBox   = document.getElementById("finalBox");
const coachBox   = document.getElementById("coachBox");

const micBadge = document.getElementById("micBadge");
const srBadge  = document.getElementById("srBadge");
const statusLine = document.getElementById("statusLine");

const toneBadge = document.getElementById("toneBadge");
const lenBadge  = document.getElementById("lenBadge");

let tone = localStorage.getItem("sc_tone") || "calm";
let length = localStorage.getItem("sc_length") || "medium";
toneBadge.textContent = tone;
lenBadge.textContent = length;

let running = false;
let finalLines = [];
const MAX_LINES = 12;

let aiTimer = null;
const AI_DEBOUNCE_MS = 700;

let micStream = null;

function setStatus(msg){
  statusLine.textContent = "ìƒíƒœ: " + msg;
}

function setListening(on){
  if(on){
    root.classList.add("listening");
    listenText.textContent = "ë“£ëŠ” ì¤‘â€¦";
    micBadge.textContent = "ë§ˆì´í¬: ì‚¬ìš©ì¤‘";
    srBadge.textContent  = "ì¸ì‹: ì§„í–‰ì¤‘";
    setStatus("ìŒì„± ì¸ì‹ ì¤‘");
  }else{
    root.classList.remove("listening");
    listenText.textContent = "ëŒ€ê¸° ì¤‘â€¦";
    micBadge.textContent = "ë§ˆì´í¬: ì¤€ë¹„";
    srBadge.textContent  = "ì¸ì‹: ì¤€ë¹„";
    setStatus("ëŒ€ê¸°");
  }
}

function pushFinalLine(line){
  if(!line) return;
  finalLines.push(line);
  if(finalLines.length > MAX_LINES) finalLines.shift();
  finalBox.value = finalLines.join("\\n");
}

function clearAll(){
  interimBox.value = "";
  finalLines = [];
  finalBox.value = "";
  coachBox.value = "";
  setStatus("ì´ˆê¸°í™” ì™„ë£Œ");
}

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recog = null;

/* ëª¨ë°”ì¼ ì•ˆì •í™”: continuous ëŠê¹€/ì¬ì‹œì‘ ëŒ€ì‘ */
function buildRecognizer(){
  const r = new SpeechRecognition();
  r.lang = "ko-KR";
  r.interimResults = true;

  // ëª¨ë°”ì¼ Chromeì€ continuousê°€ ë¶ˆì•ˆì •í•  ìˆ˜ ìˆì–´ false ê¶Œì¥(í•„ìš”ì‹œ trueë¡œ ë°”ê¿”ë„ ë¨)
  r.continuous = false;

  r.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      const txt = (res[0] && res[0].transcript) ? res[0].transcript : "";
      if (res.isFinal) {
        const cleaned = txt.trim();
        if (cleaned) {
          pushFinalLine(cleaned);
          if (toggleAI.checked) scheduleCoach();
        }
      } else {
        interim += txt;
      }
    }
    interimBox.value = interim.trim();
  };

  r.onerror = (e) => {
    srBadge.textContent = "ì¸ì‹: ì˜¤ë¥˜";
    setStatus("ì¸ì‹ ì˜¤ë¥˜: " + (e.error || "unknown"));
  };

  r.onend = () => {
    // ëª¨ë°”ì¼ì€ onendê°€ ìì£¼ ë°œìƒ â†’ runningì´ë©´ ì¬ì‹œì‘
    if (running) {
      try { r.start(); } catch {}
    }
  };

  return r;
}

async function ensureMicOnce(){
  try{
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    micBadge.textContent = "ë§ˆì´í¬: í—ˆìš©ë¨";
  }catch(e){
    micBadge.textContent = "ë§ˆì´í¬: ì°¨ë‹¨ë¨";
    throw e;
  }
}

async function start(){
  if (running) return;

  if (!SpeechRecognition) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome ê¶Œì¥)");
    return;
  }

  try{
    await ensureMicOnce();
  }catch(e){
    alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    return;
  }

  running = true;
  btnStart.disabled = true;
  btnStop.disabled = false;
  setListening(true);

  recog = buildRecognizer();
  try { recog.start(); } catch {}
}

function stop(){
  running = false;
  btnStart.disabled = false;
  btnStop.disabled = true;
  setListening(false);

  try{ if(recog) recog.stop(); }catch{}

  if(micStream){
    micStream.getTracks().forEach(t => t.stop());
    micStream = null;
  }

  interimBox.value = "";
  setStatus("ì¤‘ì§€ë¨");
}

btnStart.addEventListener("click", start);
btnStop.addEventListener("click", stop);
btnClear.addEventListener("click", clearAll);

/* AI ì½”ì¹˜ í˜¸ì¶œ */
function scheduleCoach(){
  if(aiTimer) clearTimeout(aiTimer);
  aiTimer = setTimeout(() => callCoach(), AI_DEBOUNCE_MS);
}

async function callCoach(){
  const text = finalLines.join("\\n").trim();
  if(!text) { setStatus("ì½”ì¹˜ í˜¸ì¶œ ìŠ¤í‚µ(ìµœì¢… ì „ì‚¬ ì—†ìŒ)"); return; }

  // âœ… coachBoxê°€ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ë°”ë¡œ ì•Œë¦¼(ë¬´ë°˜ì‘ ë°©ì§€)
  if(!coachBox){
    alert("ì˜¤ë¥˜: coachBox ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤. index.htmlì´ ë‹¤ë¥¸ ë²„ì „ì¼ ìˆ˜ ìˆì–´ìš”.");
    return;
  }

  coachBox.value = "ì½”ì¹­ ìƒì„± ì¤‘â€¦";
  setStatus("ì½”ì¹˜ ìš”ì²­ ì „ì†¡ ì¤‘ (/api/coach)");

  try{
    const res = await fetch("/api/coach", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ text, tone, length })
    });

    let data = null;
    try{ data = await res.json(); }catch{}

    if(!res.ok){
      coachBox.value = "ì˜¤ë¥˜: ì„œë²„ ì‘ë‹µ " + res.status;
      setStatus("ì½”ì¹˜ ì‹¤íŒ¨: HTTP " + res.status);
      return;
    }

    if(!data || !data.ok){
      coachBox.value = "ì˜¤ë¥˜: " + (data?.error || "unknown");
      setStatus("ì½”ì¹˜ ì‹¤íŒ¨: " + (data?.error || "unknown"));
      return;
    }

    const c = data.coach;
    coachBox.value =
`[ìš”ì•½]
- ${c.summary}

[í†µì°°]
- ${c.insight || ""}

[ë‹¤ìŒ í–‰ë™ 3ê°œ]
- 1) ${c.actions?.[0] || ""}
- 2) ${c.actions?.[1] || ""}
- 3) ${c.actions?.[2] || ""}

[í•œ ì¤„]
- ${c.one_liner || ""}`.trim();

    setStatus("ì½”ì¹˜ ì‘ë‹µ ìˆ˜ì‹  ì™„ë£Œ âœ…");

  }catch(e){
    coachBox.value = "ì˜¤ë¥˜: ë„¤íŠ¸ì›Œí¬/ì„œë²„ ë¬¸ì œ";
    setStatus("ì½”ì¹˜ ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬/ì„œë²„ ë¬¸ì œ");
  }
}

/* ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ë²„íŠ¼: ë§ ì•ˆ í•´ë„ ì½”ì¹˜ í˜¸ì¶œì´ ë˜ëŠ”ì§€ í™•ì¸ */
btnTest.addEventListener("click", () => {
  if(finalLines.length === 0){
    finalLines = ["ì§€ê¸ˆ ìƒíƒœ ì ê²€: ì½”ì¹˜ê°€ ì‘ë‹µí•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤."];
    finalBox.value = finalLines.join("\\n");
  }
  callCoach();
});

</script>
</body>
</html>
